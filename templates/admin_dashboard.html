<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin • Unitel AI Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--g:#00b140;--g2:#008a31;--ink:#111827;--muted:#6b7280;--bg:#f8fafc;--card:#fff;--bd:#e5e7eb;--sh:0 10px 20px rgba(0,0,0,.06)}
    *{box-sizing:border-box} body{margin:0;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#fff;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:10}
    header .brand{display:flex;align-items:center;gap:12px}
    header img{height:28px}
    header nav a{color:var(--ink);text-decoration:none;font-weight:700;margin-left:16px}
    header nav a:hover{text-decoration:underline}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:var(--sh)}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--bd)}
    .card .body{padding:14px 16px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:14px;box-shadow:var(--sh)}
    .kpi .v{font-size:26px;font-weight:800}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--g);background:var(--g);color:#fff;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
    .btn.secondary{border-color:var(--bd);background:#fff;color:var(--ink)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:14px}
    pre.log{background:#0b1220;color:#d1e4ff;border-radius:12px;border:1px solid #13203a;max-height:260px;overflow:auto;padding:12px;margin:0}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px}
    .bg-ok{background:#d1fae5;color:#065f46}
    .bg-warn{background:#fef3c7;color:#92400e}
    .bg-err{background:#fee2e2;color:#7f1d1d}
    .bg-info{background:#dbeafe;color:#1e40af}
    @media (max-width:900px){.kpis{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/static/images/unitel-logo.png" alt="Unitel">
    <strong>Admin</strong>
  </div>
  <nav>
    <a href="{{ url_for('index') }}">Нүүр</a>
    <a href="{{ url_for('scraper.report') }}">Scraper тайлан</a>
    <a href="{{ url_for('admin_users_list') }}">Хэрэглэгчид</a>
    <a href="{{ url_for('logout') }}">Гарах</a>
  </nav>
</header>

<div class="container">
  <div class="grid">
    <!-- SCRAPER CONTROL -->
    <section class="card">
      <h3>Scraper хяналт</h3>
      <div class="body">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">Статус: <span id="stBadge" class="badge bg-info">Тодорхойгүй</span></div>
            <div class="muted">Эхэлсэн: <span id="stStart">-</span> • Дууссан: <span id="stFinish">-</span></div>
            <div class="muted">Алдаа: <span id="stErr">-</span></div>
          </div>
          <div class="row">
            <button id="btnScrape" class="btn">⚡ Scrape Now</button>
            <a class="btn secondary" href="{{ url_for('scraper.download_tsv') }}">⬇️ TSV</a>
            <a class="btn secondary" href="{{ url_for('scraper.download_xlsx') }}">⬇️ XLSX</a>
          </div>
        </div>
        <div style="margin-top:12px">
          <pre id="log" class="log">Логын сүүлээс…</pre>
        </div>
      </div>
    </section>

    <!-- KPIs (жишээ) -->
    <section class="card">
      <h3>Үзүүлэлт (жишээ)</h3>
      <div class="body kpis">
        <div class="kpi"><div class="muted">Сүүлийн 30 хоног</div><div class="v" id="kpiCount">-</div></div>
        <div class="kpi"><div class="muted">Идэвхтэй кампанит ажил</div><div class="v" id="kpiActive">-</div></div>
        <div class="kpi"><div class="muted">Өнөөдрийн шинэ</div><div class="v" id="kpiNew">-</div></div>
      </div>
    </section>
  </div>
</div>

<script>
const el = s => document.querySelector(s);
const btnScrape = el('#btnScrape');
const stBadge = el('#stBadge'), stStart = el('#stStart'), stFinish = el('#stFinish'), stErr = el('#stErr');
const logEl = el('#log');
const kpiCount = el('#kpiCount'), kpiActive = el('#kpiActive'), kpiNew = el('#kpiNew');

function badge(kind, txt){
  const map = {ok:'bg-ok', warn:'bg-warn', err:'bg-err', info:'bg-info'};
  stBadge.className = 'badge ' + (map[kind]||'bg-info');
  stBadge.textContent = txt;
}

async function pollStatus(){
  try{
    const r = await fetch('{{ url_for("scraper.scraper_status_bp") }}?ts=' + Date.now(), {cache:'no-store'});
    if(!r.ok) throw new Error(r.status);
    const s = await r.json();
    if(s.running){ badge('info','Ажиллаж байна'); btnScrape.disabled = true; }
    else{
      badge(s.last_error ? 'err':'ok', s.last_error ? 'Алдаа' : 'Бэлэн');
      btnScrape.disabled = false;
    }
    stStart.textContent = s.started || '-';
    stFinish.textContent = s.finished || '-';
    stErr.textContent = s.last_error || '-';
    if (Array.isArray(s.log_tail)){
      logEl.textContent = s.log_tail.join('\n');
      logEl.scrollTop = logEl.scrollHeight;
    }
  }catch(e){
    badge('err','Статус алдаа');
  }
}
async function triggerScrape(){
  try{
    btnScrape.disabled = true;
    await fetch('{{ url_for("scraper.scrape_now_bp") }}', {method:'POST', headers:{'X-Requested-With':'fetch'}});
    setTimeout(pollStatus, 600);
  }catch(e){ btnScrape.disabled = false; }
}

async function loadKPIs(){
  try{
    const r = await fetch('/ads/api/summary?days=30');
    const j = await r.json();
    if(j.ok){
      const items = j.items || [];
      kpiCount.textContent = items.length;
      const today = new Date().toISOString().slice(0,10);
      kpiActive.textContent = items.filter(x=>(x.status||'').toLowerCase().includes('active')).length;
      kpiNew.textContent = items.filter(x=>x.last_seen_date===today).length;
    }
  }catch(e){}
}

btnScrape?.addEventListener('click', triggerScrape);
pollStatus(); loadKPIs();
setInterval(pollStatus, 1500);
</script>
</body>
</html>
