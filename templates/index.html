<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unitel AI Hub ‚Äî Assistant</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#00b140; --brand-weak:#e6f7ec;
      --ink:#0f172a; --muted:#64748b; --subtle:#94a3b8;
      --bg:#f5f7fb; --card:#ffffff; --line:#e5e7eb;
      --glow:rgba(0,177,64,.18);
      --shadow-lg:0 12px 30px rgba(2,6,23,.08);
      --danger:#ef4444;
    }
    :root.dark {
      --ink:#f8fafc; --muted:#cbd5e1; --subtle:#94a3b8;
      --bg:#0b1220; --card:#172033; --line:#2a3a56;
      --brand-weak:rgba(0,177,64,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    .nav{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.7);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .dark .nav{background:rgba(23,32,51,.7)}
    .nav-inner{max-width:1120px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;text-decoration:none;color:var(--ink)}
    .brand img{height:28px}
    .menu{display:flex;gap:10px;align-items:center}
    .menu a{color:var(--muted);text-decoration:none;font-weight:600;padding:8px 12px;border-radius:12px}
    .menu a:hover{background:var(--brand-weak);color:var(--brand)}
    .btn-ghost{border:1px solid var(--line);background:transparent;color:var(--muted);border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn-ghost:hover{border-color:var(--brand);color:var(--brand)}
    .btn-admin{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:8px 14px;box-shadow:0 8px 24px var(--glow);cursor:pointer}
    .user{display:flex;align-items:center;gap:10px;color:var(--muted);font-weight:600}
    .logout{border:1px solid var(--line);background:#fff;color:#0f172a;border-radius:10px;padding:6px 10px;cursor:pointer}
    .dark .logout{background:#1d2942;color:#e5e7eb}

    /* Hero + features */
    .wrap{max-width:1120px;margin:40px auto;padding:0 20px}
    .hero{display:grid;grid-template-columns:1.15fr .85fr;gap:20px}
    @media (max-width:980px){.hero{grid-template-columns:1fr}}
    .hero-card{background:linear-gradient(135deg,var(--brand),#00c555);color:#fff;border-radius:20px;padding:34px;box-shadow:0 18px 40px rgba(0,177,64,.25);position:relative;overflow:hidden}
    .hero-card:after{content:"";position:absolute;right:-20%;bottom:-60%;width:70%;height:200%;border-radius:50%;background:radial-gradient(closest-side,rgba(255,255,255,.22),transparent)}
    .hero h1{margin:0 0 8px;font-size:clamp(28px,4vw,42px);line-height:1.15}
    .pill{display:inline-flex;gap:8px;margin-top:16px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);padding:8px 14px;border-radius:999px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:820px){.grid3{grid-template-columns:1fr 1fr}}
    @media (max-width:560px){.grid3{grid-template-columns:1fr}}
    .feat{padding:16px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.65);backdrop-filter:blur(8px)}
    .dark .feat{background:rgba(23,32,51,.65)}

    /* Chat card */
    .chat{margin-top:38px;border:1px solid var(--line);border-radius:20px;background:var(--card);box-shadow:var(--shadow-lg);overflow:hidden}
    .chat-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
    .status{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 6px var(--brand-weak)}

    .chat-body{height:min(56vh,540px);min-height:360px;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.02));padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .bubble{max-width:78%;padding:12px 14px;border-radius:16px;line-height:1.6;word-wrap:break-word;word-break:break-word}
    .bot{background:#eef2f7;border:1px solid var(--line);color:#233044;border-top-left-radius:6px}
    .dark .bot{background:#243149;border-color:#2e436a;color:#dbe7ff}
    .me{background:#d7f6e6;color:#065f46;border-top-right-radius:6px;margin-left:auto}
    .meta{opacity:.6;font-size:11px;margin-top:6px}

    /* Composer */
    .composer{border-top:1px solid var(--line);background:var(--card);padding:12px}
    .row{display:flex;gap:10px;align-items:flex-end}
    .icbtn{flex:0 0 44px;height:44px;display:grid;place-items:center;border:none;border-radius:12px;background:var(--brand);color:#fff;cursor:pointer;box-shadow:0 10px 26px var(--glow)}
    .send{min-width:110px;height:44px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 10px 26px var(--glow)}
    .send[disabled]{opacity:.6;cursor:not-allowed}
    .ta{flex:1;min-height:44px;max-height:180px;resize:none;outline:none;border:1px solid var(--line);border-radius:12px;background:var(--card);color:var(--ink);padding:12px 14px;line-height:1.55}
    .ta:focus{border-color:var(--brand);box-shadow:0 0 0 5px var(--brand-weak)}
    .hint{font-size:12px;color:var(--subtle);padding:6px 2px 0}

    /* Dropzone + files */
    .drop{margin-top:8px;border:1px dashed var(--line);border-radius:12px;padding:10px 12px;color:var(--subtle);font-size:13px}
    .drop.drag{border-color:var(--brand);background:var(--brand-weak);color:var(--brand)}
    .files{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .file{display:inline-flex;align-items:center;gap:8px;background:#eef2ff;border:1px solid #c7d2fe;color:#1e2a78;padding:6px 10px;border-radius:999px;font-size:12px}
    .file button{all:unset;cursor:pointer;color:#6b7280;font-size:16px;line-height:1}

    /* Typing */
    .typing{display:inline-flex;gap:6px}
    .typing .d{width:6px;height:6px;border-radius:50%;background:#9aa6b2;animation:b 1.2s infinite}
    .typing .d:nth-child(2){animation-delay:.12s}.typing .d:nth-child(3){animation-delay:.24s}
    @keyframes b{0%,80%,100%{transform:translateY(0);opacity:.35}40%{transform:translateY(-3px);opacity:1}}

    .toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:#1f2a40;color:#fff;border-radius:12px;padding:10px 14px;font-size:14px;opacity:0;pointer-events:none;transition:.2s}
    .toast.show{opacity:1}
    footer{margin:32px 0 50px;text-align:center;color:var(--subtle);font-size:13px}

    /* Mini admin chip (only for admin) */
    .admin-bar{display:flex;align-items:center;gap:10px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--brand-weak);color:var(--brand);font-weight:800;font-size:12px}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="nav">
    <div class="nav-inner">
      <a class="brand" href="/">
        <img src="/static/images/unitel-logo.png" alt="Unitel logo">
        <span>Unitel AI Hub</span>
      </a>

      <div class="menu">
        <a href="/">–ù“Ø“Ø—Ä</a>
        <a href="/scraper/">Ad report</a>

        <!-- –ó”©–≤—Ö”©–Ω –ê–î–ú–ò–ù —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥—ç–¥ "–ê–¥–º–∏–Ω" —Ç–æ–≤—á —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞ -->
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <a class="btn-admin" href="/admin/users">–ê–¥–º–∏–Ω</a>
        {% endif %}

        <button id="mode" class="btn-ghost" title="Dark/Light">üåô</button>

        <!-- –ù—ç–≤—Ç—ç—Ä—Å—ç–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª + –≥–∞—Ä–∞—Ö -->
        {% if current_user.is_authenticated %}
          <div class="user">
            {{ current_user.email }}
            <form method="post" action="{{ url_for('logout') }}">
              <button class="logout" type="submit" title="–ì–∞—Ä–∞—Ö">–ì–∞—Ä–∞—Ö</button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- Hero -->
  <div class="wrap">
    <!-- –ê–¥–º–∏–Ω –±–∞—Ä–∞–∞ (–∂–∏–∂–∏–≥ —Ç–∞–π–ª–±–∞—Ä) -->
    {% if current_user.is_authenticated and current_user.role == 'admin' %}
      <div class="admin-bar" style="margin-bottom:16px">
        <span class="badge">Admin</span>
        <span style="color:var(--muted)">–•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∑”©–≤—à”©”©—Ä”©–ª, –∏–¥—ç–≤—Ö–∂–∏–ª—Ç–∏–π–≥ <a href="/admin/users">–ê–¥–º–∏–Ω —Å–∞–º–±–∞—Ä</a>-–∞–∞—Å —É–¥–∏—Ä–¥–∞–Ω–∞.</span>
      </div>
    {% endif %}

    <section class="hero">
      <div class="hero-card">
        <h1>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ & –ò–Ω–Ω–æ–≤–∞—Ü–∏–π–Ω AI –¢—É—Å–ª–∞—Ö</h1>
        <p>Facebook —Ç–∞–π–ª–∞–Ω, 7 —Ö–æ–Ω–æ–≥–∏–π–Ω sentiment, Ad report ‚Äî –±“Ø–≥–¥ –Ω—ç–≥ —Ç–æ–≤—à–∏–ª—Ç–æ–æ—Ä.</p>
        <div class="pill">‚ö° –¢“Ø—Ä–≥—ç–Ω –∫–æ–º–∞–Ω–¥—É—É–¥: ‚Äúgraph api —Ç–∞–π–ª–∞–Ω‚Äù, ‚Äúads —Ç–∞–π–ª–∞–Ω‚Äù, ‚Äú7 —Ö–æ–Ω–æ–≥–∏–π–Ω sentiment‚Äù</div>
      </div>
      <div class="grid3">
        <div class="feat"><b>üìä Facebook —Ç–∞–π–ª–∞–Ω</b><br/>–ü–æ—Å—Ç/–∫–æ–º–º–µ–Ω—Ç —Ç–∞—Ç–∞–∂ CSV/XLSX –±–æ–ª–≥–æ–∂ —ç–∫—Å–ø–æ—Ä—Ç–ª–æ–Ω–æ.</div>
        <div class="feat"><b>üß† Sentiment</b><br/>–≠–µ—Ä—ç–≥/—Å”©—Ä”©–≥/—Ç”©–≤–∏–π–Ω & —Å—ç–¥—ç–≤ –∞–Ω–≥–∏–ª–∞–ª.</div>
        <div class="feat"><b>üìà Ads</b><br/>–°–∞–π—Ç—É—É–¥—ã–Ω —Å—É—Ä—Ç–∞–ª—á–∏–ª–≥–∞–∞–Ω—ã –Ω—ç–≥–¥—Å—ç–Ω —Ç–∞–π–ª–∞–Ω.</div>
      </div>
    </section>

    <!-- Chat -->
    <section class="chat" aria-label="Assistant">
      <div class="chat-head">
        <div class="status"><span class="dot"></span>Unitel Assistant</div>
        <div style="color:var(--subtle);font-size:12px">Beta</div>
      </div>

      <div id="chat" class="chat-body" role="log" aria-live="polite"></div>

      <div class="composer">
        <div class="row">
          <button id="pick" class="icbtn" title="–§–∞–π–ª —Ö–∞–≤—Å–∞—Ä–≥–∞—Ö">üìé</button>
          <textarea id="msg" class="ta" rows="1" placeholder="–ê—Å—É—É–ª—Ç–∞–∞ —ç–Ω–¥ –±–∏—á–Ω—ç “Ø“Ø‚Ä¶ (Shift+Enter = —à–∏–Ω—ç –º”©—Ä)"></textarea>
          <button id="send" class="send">–ò–ª–≥—ç—ç—Ö</button>
        </div>
        <div id="dz" class="drop">CSV, TSV, XLSX, TXT, JSON, PDF, DOCX –∑—ç—Ä—ç–≥ —Ñ–∞–π–ª—É—É–¥—ã–≥ —ç–Ω–¥ —á–∏—Ä–∂ —É–Ω–∞–≥–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π</div>
        <input id="file" type="file" hidden multiple
          accept=".txt,.csv,.tsv,.xlsx,.xls,.json,.pdf,.doc,.docx,.md,.html,.htm,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/pdf,text/plain,text/csv,application/json" />
        <div id="files" class="files" aria-live="polite"></div>
        <div class="hint">–°–∞–Ω–∞–ª: ‚Äú–≠–Ω—ç —Ñ–∞–π–ª –¥—ç—ç—Ä sentiment + —Å—ç–¥—ç–≤—á–∏–ª—Å—ç–Ω —Ç–∞–π–ª–∞–Ω –≥–∞—Ä–≥–∞‚Äù –≥—ç—Ö –º—ç—Ç —Ç–æ–¥–æ—Ä—Ö–æ–π –∞—Å—É—É–ª—Ç –∞—à–∏–≥–ª–∞.</div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast">–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.</div>
  <footer>¬© 2025 Unitel Innovation Hub</footer>

  <script>
    // shortcuts
    const $=(s,p=document)=>p.querySelector(s), $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
    const chat=$("#chat"), msg=$("#msg"), send=$("#send"), pick=$("#pick"), file=$("#file"), dz=$("#dz"), files=$("#files");
    const toast=$("#toast"), mode=$("#mode");
    let queue=[]; let typing=null; let sending=false;

    // theme
    const root=document.documentElement;
    if(localStorage.getItem("ui-theme")==="dark"){ root.classList.add("dark"); mode.textContent="‚òÄÔ∏è"; }
    mode.onclick=()=>{ root.classList.toggle("dark"); localStorage.setItem("ui-theme", root.classList.contains("dark")?"dark":"light"); mode.textContent=root.classList.contains("dark")?"‚òÄÔ∏è":"üåô"; };

    // helpers
    const tstamp=()=>new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const esc=s=>s.replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));
    const linkify=t=>esc(t).replace(/(https?:\/\/[^\s]+|\/report\/[^\s]+)/g,m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
    const md = (s)=> linkify(s)
      .replace(/\*\*(.+?)\*\*/g,"<b>$1</b>")
      .replace(/\*(.+?)\*/g,"<i>$1</i>")
      .replace(/^\s*-\s+(.*)$/gm,"‚Ä¢ $1")
      .replace(/\n/g,"<br>");

    const bubble=(html,who="bot")=>{
      const b=document.createElement("div");
      b.className=`bubble ${who==="me"?"me":"bot"}`;
      b.innerHTML=html+`<div class="meta">${tstamp()}</div>`;
      chat.appendChild(b); chat.scrollTop=chat.scrollHeight;
    };
    const showTyping=()=>{ if(typing) return; typing=document.createElement("div"); typing.className="bubble bot"; typing.innerHTML=`<span class="typing"><span class="d"></span><span class="d"></span><span class="d"></span></span>`; chat.appendChild(typing); chat.scrollTop=chat.scrollHeight; };
    const hideTyping=()=>{ if(typing){ typing.remove(); typing=null; } };
    const toastIt=(m)=>{ toast.textContent=m; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),1800); };

    // textarea autosize + Enter
    const autosize=()=>{ msg.style.height="auto"; msg.style.height=Math.min(msg.scrollHeight,180)+"px"; };
    msg.addEventListener("input", autosize);
    msg.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); doSend(); } });

    // file UI
    pick.onclick=()=>file.click();
    const paintFiles=()=>{
      files.innerHTML="";
      queue.forEach((f,i)=>{
        const tag=document.createElement("span");
        tag.className="file";
        tag.innerHTML=`${esc(f.name)} (${Math.round(f.size/1024)}KB) <button title="remove">&times;</button>`;
        tag.querySelector("button").onclick=()=>{ queue.splice(i,1); paintFiles(); };
        files.appendChild(tag);
      });
    };
    file.onchange=(e)=>{ queue.push(...Array.from(e.target.files)); paintFiles(); file.value=""; };
    ["dragenter","dragover"].forEach(ev=>dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.add("drag"); }));
    ["dragleave","drop"].forEach(ev=>dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.remove("drag"); }));
    dz.addEventListener("drop", e=>{ queue.push(...Array.from(e.dataTransfer.files)); paintFiles(); });

    // send
    const doSend = async ()=>{
      if(sending) return;
      const text = msg.value.trim();
      if(!text && queue.length===0) return;

      // show my message
      let my = text ? md(text) : "(—Ñ–∞–π–ª –∏–ª–≥—ç—ç–≤)";
      if(queue.length) my += `<div class="meta" style="margin-top:6px;opacity:.8">–•–∞–≤—Å–∞—Ä–≥–∞—Å–∞–Ω: ${queue.map(f=>esc(f.name)).join(", ")}</div>`;
      bubble(my,"me");

      msg.value=""; autosize(); showTyping(); sending=true; send.disabled=true; send.textContent="–ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞‚Ä¶";

      try{
        let res;
        if(queue.length){
          const fd=new FormData();
          fd.append("message", text);
          queue.forEach(f=>fd.append("files", f, f.name));
          res = await fetch("/chatbot",{ method:"POST", body:fd, credentials:"include" });
        }else{
          res = await fetch("/chatbot",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({question:text}), credentials:"include" });
        }
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data = await res.json();
        hideTyping(); sending=false; send.disabled=false; send.textContent="–ò–ª–≥—ç—ç—Ö";
        bubble(md(data?.response || "–•–∞—Ä–∏—É–ª—Ç –æ–ª–¥—Å–æ–Ω–≥“Ø–π."),"bot");
      }catch(err){
        console.error(err);
        hideTyping(); sending=false; send.disabled=false; send.textContent="–ò–ª–≥—ç—ç—Ö";
        toastIt("–°–µ—Ä–≤–µ—Ä—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π."); bubble("–£—É—á–ª–∞–∞—Ä–∞–π, –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.","bot");
      }finally{
        queue=[]; paintFiles();
      }
    };
    send.onclick=doSend;

    // initial message
    window.addEventListener("DOMContentLoaded",()=>{
      bubble("–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É! –ë–∏ –±–æ–ª <b>Unitel AI —Ç—É—Å–ª–∞—Ö</b>. CSV/TSV/XLSX —ç—Å–≤—ç–ª —Ç–µ–∫—Å—Ç —Ñ–∞–π–ª —Ö–∞–≤—Å–∞—Ä–≥–∞–∞–¥ ‚ÄúSentiment –±–∞ —Å—ç–¥—ç–≤—á–∏–ª—Å—ç–Ω —Ç–∞–π–ª–∞–Ω –≥–∞—Ä–≥–∞‚Äù –≥—ç–∂ –±–∏—á—ç—ç—Ä—ç–π.","bot");
      autosize();
    });
  </script>
</body>
</html>
